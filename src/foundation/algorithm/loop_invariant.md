# 循环不变式
**循环不变式(Loop Invariant)** 是非常基础的一个概念，它是计算机科学中用于证明循环正确性的一种重要逻辑工具。是指在循环的每次迭代前后都保持为真的性质或条件，帮助验证循环的行为是否符合预期。

## 定义
循环不变式是在循环开始前、每次迭代后以及循环结束后均成立的逻辑断言。它反映了循环中变量的内在关系，与循环的终止条件共同保证程序的正确性。

## 性质
循环不变式有以下三条必须要满足的性质，这三条需要我们通过数学方法证明:

- **初始化**：循环开始前，不变式因变量初始值而成立。
- **保持**：若某次迭代前不变式成立，则执行循环体后仍成立。
- **终止**：循环结束时，不变式+终止条件共同推出目标结果。

这个定义非常漂亮，但还有更好理解的版本(《算法导论》原始版本的修改):

- **初始化**: 循环开始前，不变式成立。
- **保持**: 在某次迭代开始之前它成立，则迭代之后仍成立。
- **终止**: 循环结束后，不变式提供一个性质来证明算法正确性。

## 解释
上面的这些内容比较抽象，但我们以代码为例就可以看出它们在讲什么:
```rs
// 典型: 数组求和
fn sum(arr: &[usize]) -> usize {
    let mut total = 0;  // 需要 mut
    let mut i = 0;      // 需要 mut
    while i < arr.len() {  // arr.len() 不是 len(arr)
        total += arr[i];
        i += 1;
    }
    total
}
```
让我们分析这个函数是否满足循环不变式，并进行证明。给定的循环不变式有两个：
1. `total = arr + arr + ... + arr[i-1]`
2. `i <= arr.len()`

### 证明
我们需要证明：
1. **初始化**: 在循环开始前，不变式成立。
2. **保持**: 如果在某次迭代前不变式成立，那么在下一次迭代前仍然成立。
3. **终止**: 循环终止时，不变式能推出算法的正确性。

#### 1. 初始化
在循环开始前：
- `total = 0`
- `i = 0`
- `total = arr + ... + arr[i-1]` 是空和(因为 `i-1 = -1`)，空和为 `0`，所以 `total = 因为 i-1 = -10` 满足。
- `i = 0 <= arr.len()` 也成立。

#### 2. 保持
假设在某次迭代前：
- `total = arr + ... + arr[i-1]`
- `i <= arr.len()`

执行循环体：
- `total += arr[i] ⇒ total = arr + ... + arr[i]`
- `i += 1 ⇒ i 变为 i+1`

此时：
- `total = arr + ... + arr[(i+1)-1]` (因为 `i` 是更新后的值)，所以不变式仍然成立。
- `i <= arr.len()`: 因为循环条件是 `i < arr.len()`，所以更新后的 `i` 满足 `i <= arr.len()`。

#### 3. 终止
循环终止时：
- `i == arr.len()` (因为循环条件是 i < arr.len()，且 i 每次增加 1)
- 此时 `total = arr + ... + arr[i-1] = arr + ... + arr[arr.len()-1]`，即整个数组的和。

因此，循环终止时 `total` 的值确实是数组所有元素的和，算法正确。
